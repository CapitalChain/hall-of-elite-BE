generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String           @id @default(uuid())
  email         String           @unique
  password      String
  displayName   String
  role          String           @default("TRADER") // TRADER | ADMIN
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  tradingAccounts TradingAccount[]
}

model TradingAccount {
  id            String   @id @default(uuid())
  userId        String
  accountNumber String   @unique
  broker        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades        Trade[]
  traderMetrics TraderMetrics[]
}

model Trade {
  id              String   @id @default(uuid())
  tradingAccountId String
  symbol          String
  type            String
  volume          Float
  openPrice       Float
  closePrice      Float?
  profit          Float?
  openTime        DateTime
  closeTime       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tradingAccount  TradingAccount @relation(fields: [tradingAccountId], references: [id], onDelete: Cascade)
}

model TraderMetrics {
  id              String   @id @default(uuid())
  tradingAccountId String   @unique
  totalTrades     Int      @default(0)
  winningTrades   Int      @default(0)
  losingTrades    Int      @default(0)
  totalProfit     Float    @default(0)
  totalLoss       Float    @default(0)
  winRate         Float    @default(0)
  profitFactor    Float    @default(0)
  averageWin      Float    @default(0)
  averageLoss     Float    @default(0)
  largestWin      Float    @default(0)
  largestLoss     Float    @default(0)
  currentDrawdown Float    @default(0)
  maxDrawdown     Float    @default(0)
  sharpeRatio     Float    @default(0)
  periodStart     DateTime @default(now())
  periodEnd       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tradingAccount  TradingAccount @relation(fields: [tradingAccountId], references: [id], onDelete: Cascade)
}

model TraderScore {
  id              String   @id @default(uuid())
  tradingAccountId String   @unique
  tier            String
  rank            Int
  score           Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Tier {
  id          String   @id @default(uuid())
  name        String   @unique
  minScore    Float
  maxScore    Float?
  color       String?
  icon        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reward {
  id          String   @id @default(uuid())
  tier        String
  rewardType  String
  name        String
  description String?
  amount      Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  entitlements RewardEntitlement[]
}

model RewardEntitlement {
  id          String   @id @default(uuid())
  traderId    String
  rewardId    String
  rewardType  String
  amount      Float
  status      String   @default("PENDING")
  eligibleAt  DateTime
  expiresAt   DateTime?
  claimedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reward      Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)
}
